{
  "title": "Gun.js 加密聊天室任務指派系統：完整除錯研究報告（2026-03-01）",
  "content": "# Gun.js 加密聊天室任務指派系統：完整除錯研究報告\n\n**日期**：2026-03-01\n**專案**：daily-digest-prompt / wsc-bot\n**狀態**：✅ 全工作流程驗證成功\n\n## 一、系統架構概述\n\n本系統實現一個基於 Gun.js 的去中心化加密聊天室，使用者可透過 UI 指派任務，Bot 接收並儲存，Worker 認領執行（claude -p），結果加密廣播回聊天室。\n\n核心流程：index.html → SEA.encrypt → Gun Relay → bot.js 接收儲存 → process_messages.ps1 認領 → claude -p 執行 → /api/records/processed → bot.js sendSystemReply → Gun Relay → index.html 解密顯示\n\n## 二、SEA 加密協定詳解\n\n### 金鑰類型區分（關鍵易混淆點）\n\n- ECDH 金鑰對（epub/epriv）：Curve25519，用於計算共享密鑰 SEA.secret()\n- ECDSA 金鑰對（pub/priv）：P-256，用於簽章驗證 SEA.verify()\n\n**正確驗證方式**：\n- ❌ 錯誤：SEA.verify(hw.sig, hw.epub) — 用 ECDH epub 驗 ECDSA 簽章，永遠失敗\n- ✅ 正確：SEA.verify(hw.sig, hw.pub) — 用 ECDSA pub 驗，正常運作\n\n### 訊息格式（與 index.html 完全一致）\n\n```javascript\n// 加密內容\nconst payload = JSON.stringify({ text: userMessage, ts: Date.now() });\nconst encryptedData = await SEA.encrypt(payload, sharedSecret);\n// Gun 路徑\nconst msgId = 'msg_' + randomHex(12);\ngun.get(chatRoomName).get(msgId).put(encryptedData); // 直接放，不包裝\n```\n\n## 三、握手協定\n\nBot 發布：gun.get('wsc-bot/handshake').put({ epub, sig, pub }) 含 ECDSA pub 供驗證\nBot 兼容路徑：gun.get('wsc-bot/handshake').get('bot-epub').put(myPair.epub)\nBot relay 重連補發：gun.on('hi', () => 補發 epub)（解決 Render.com 重啟問題）\n\n客端 epub 發布（握手）：\n- gun.get('wsc-bot/handshake').get('client-epub').put(myPair.epub)  // 向下相容\n- gun.get('wsc-bot/handshake').get('clients').get(myPair.pub).put(myPair.epub)  // 多用戶\n- 發布後需等待 8 秒，讓 Bot 建立 sharedSecret\n\n## 四、發現的 6 個 Bug 與修復\n\n### Bug 1：SEA.verify 使用錯誤金鑰\n根因：SEA.verify(hw.sig, hw.epub) 永遠失敗（epub 是 ECDH 非 ECDSA）\n修復：改為 SEA.verify(hw.sig, hw.pub)\n檔案：D:\\Source\\my-gun-relay\\index.html\n\n### Bug 2：Relay 重啟後 Bot epub 消失\n根因：bot.js 只在 init() 發布一次 epub，relay 重啟後資料消失未補發\n修復：gun.on('hi', ...) 加入補發邏輯，epubSig 升級為模組層級變數\n\n### Bug 3：Bot 自身回覆被誤存為新任務\n根因：SEA.decrypt({text,ts}) 回傳物件，String(obj)='[object Object]' 繞過過濾\n修復：先檢查 typeof raw === 'string'，否則取 raw.text\n\n### Bug 4：settings.json Hook 路徑損壞\n根因：bash 將 D:\\\\Source\\\\... 的反斜線解析為逃逸字元，路徑損壞\n修復：所有 hook command 改用正斜線 D:/Source/daily-digest-prompt/hooks/xxx.py\n\n### Bug 5：Worker CLAUDECODE 巢狀 Session 阻擋（最關鍵）\n根因：Claude Code 設定 CLAUDECODE 用戶環境變數，Task Scheduler 繼承後 claude -p 拒絕啟動\n症狀：Worker log 顯示 claude -p 在 <1 秒內完成，結果是錯誤訊息\n修復：process_messages.ps1 在 claude -p 前 Remove-Item Env:\\CLAUDECODE，finally 還原\nwsc-bot01 不受影響：因使用 OpenAI codex exec（無 CLAUDECODE 限制）\n\n### Bug 6：測試腳本訊息格式錯誤\n根因：put({ d: encrypted, ts }) 包裝格式，bot 嘗試 SEA.decrypt({d,ts}) 失敗\n修復：直接 put(encryptedData)，且加密 JSON.stringify({text,ts}) 非純文字\n\n## 五、完整工作流程驗證結果\n\n成功時間線（2026-03-01 10:44-10:47）：\n- 10:44:02 用戶發送加密任務 msg_1f2a01c2e34b\n- 10:44:03 Bot 確認：[系統回覆] 已將任務存為檔案...（研究型: true）\n- 10:46:10 Task Scheduler Worker 啟動，認領任務\n- 10:46:13 任務強化完成（33 字 → 1583 字）\n- 10:46:13 claude -p 開始執行（已清除 CLAUDECODE，31 秒執行）\n- 10:46:44 Bot sendSystemReply → 加密廣播台灣 AI 產業三大發展機會分析\n- 端對端總耗時：約 2.5-3 分鐘（含 Task Scheduler 等待 ~2 分鐘）\n\n## 六、Gun.js 重要行為特性\n\n- .once() null 行為：無快取時立即以 null 回呼，需多次 retry + fallback\n- .map().on() 歷史資料：附加後對現有所有資料觸發回呼，需用 processedMessages 去重\n- Render.com Free Tier：每 ~15 分鐘重啟，radisk 資料消失，需 relay reconnect republish\n\n## 七、架構建議\n\n1. 使用本地 relay 開發（localhost:8765）比 Render.com 穩定\n2. epub 握手等待 8 秒確保 bot 建立 sharedSecret\n3. Task Scheduler 執行 claude -p 前必須清除 CLAUDECODE\n4. 嚴格遵守訊息格式：JSON.stringify({text,ts}) + 直接 put\n5. 多路徑握手：同時發布 client-epub 和 clients/<pub>",
  "source": "manual",
  "metadata": {
    "type": "research-report",
    "project": "wsc-bot / daily-digest-prompt",
    "date": "2026-03-01",
    "tags": ["Gun.js", "SEA加密", "ECDH", "ECDSA", "claude-p", "CLAUDECODE", "Task-Scheduler", "Worker", "chatroom", "debug", "architecture"]
  }
}
