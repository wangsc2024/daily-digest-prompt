# 每日系統審查自動化設定說明

**建立日期**：2026-02-17
**版本**：1.0.0

---

## 概述

已新增每日系統審查排程，每天凌晨 00:40 自動執行系統評分、問題修正，並將審查報告寫入 RAG 知識庫。

### 核心功能

1. **自動評分**：使用 `system-audit` Skill 對專案進行 7 維度、38 子項完整評估
2. **並行加速**：Phase 1 四路並行審查（維度 1+5, 2+6, 3+7, 4），Phase 2 組裝修正
3. **智能修正**：自動修正可處理的問題（最多 5 項），如新增配置檔、更新文件
4. **知識庫整合**：審查報告自動寫入 RAG (localhost:3000)，含結構化 metadata
5. **趨勢追蹤**：記錄歷史分數，比對進退步

---

## 新增檔案

### 1. Team Prompt 檔案（Phase 1 並行審查）

**`prompts/team/fetch-audit-dim1-5.md`**
- 評估維度 1（資訊安全，6 子項）+ 維度 5（技術棧，6 子項）
- 輸出 `results/audit-dim1-5.json`

**`prompts/team/fetch-audit-dim2-6.md`**
- 評估維度 2（系統架構，6 子項）+ 維度 6（系統文件，5 子項）
- 輸出 `results/audit-dim2-6.json`

**`prompts/team/fetch-audit-dim3-7.md`**
- 評估維度 3（系統品質，6 子項）+ 維度 7（系統完成度，5 子項）
- 輸出 `results/audit-dim3-7.json`

**`prompts/team/fetch-audit-dim4.md`**
- 評估維度 4（系統工作流，5 子項）
- 輸出 `results/audit-dim4.json`

### 2. Assembly Prompt（Phase 2 組裝與修正）

**`prompts/team/assemble-audit.md`**
包含 8 個執行步驟：
- Step 1：讀取 Phase 1 的 4 個 JSON 結果
- Step 2：計算加權總分與等級（S/A/B/C/D/F）
- Step 3：識別問題項目（分數 <70 或退步 >5）
- Step 4：自動修正（最多 5 項可自動處理項目）
- Step 5：重新審查（若有修正，重新評分）
- Step 6：生成報告（使用 `templates/audit-report.md` 模板）
- Step 7：寫入知識庫（POST 到 localhost:3000/api/notes）
- Step 8：清理（刪除 `results/` 中間檔案，更新 `state/last-audit.json`）

### 3. 執行腳本

**`run-system-audit-team.ps1`**（271 行，推薦）

- PowerShell 7 腳本，團隊並行模式
- Phase 1 Timeout: 600 秒（10 分鐘）× 4 個 Agent
- Phase 2 Timeout: 1200 秒（20 分鐘），失敗可重試 1 次
- 日誌輸出:
  - `logs/audit-phase1-YYYYMMDD_HHMMSS.log`（4 個 Agent 合併輸出）
  - `logs/audit-phase2-YYYYMMDD_HHMMSS.log`（組裝 Agent 輸出）
- 狀態追蹤: 寫入 `state/scheduler-state.json`
- 中間結果: `results/audit-dim*.json`（完成後自動清理）

**`run-system-audit.ps1`**（178 行，備用）

- PowerShell 7 腳本，單一模式
- Timeout: 1800 秒（30 分鐘）
- 自動重試: 1 次（間隔 60 秒）
- 日誌輸出: `logs/system-audit-YYYYMMDD_HHMMSS.log`
- 狀態追蹤: 寫入 `state/scheduler-state.json`

### 3. 狀態檔案

**`state/last-audit.json`**

記錄最近一次審查結果：
```json
{
  "total_score": 90.47,
  "grade": "S",
  "date": "2026-02-16",
  "timestamp": "2026-02-16 23:59:59",
  "dimensions": {
    "1_information_security": 91,
    "2_system_architecture": 84,
    "3_system_quality": 91,
    "4_system_workflow": 96,
    "5_technology_stack": 92,
    "6_system_documentation": 88,
    "7_system_completeness": 93
  },
  "note_id": null,
  "message": "Initial state from third round audit"
}
```

### 4. 排程定義

**`HEARTBEAT.md`** 新增：
```yaml
  system-audit:
    cron: "40 0 * * *"
    script: run-system-audit-team.ps1
    timeout: 1800
    retry: 1
    description: "每日系統審查 - 團隊模式（00:40）"
```

---

## 執行流程

### 自動執行（每日 00:40）

Windows Task Scheduler 自動觸發 → `run-system-audit-team.ps1` → 團隊並行模式

**架構**：
1. **Phase 1**：啟動 4 個並行 Agent（`Start-Job`）
   - Agent 1: `prompts/team/fetch-audit-dim1-5.md` → `results/audit-dim1-5.json`
   - Agent 2: `prompts/team/fetch-audit-dim2-6.md` → `results/audit-dim2-6.json`
   - Agent 3: `prompts/team/fetch-audit-dim3-7.md` → `results/audit-dim3-7.json`
   - Agent 4: `prompts/team/fetch-audit-dim4.md` → `results/audit-dim4.json`
   - 等待全部完成（timeout 600s），驗證 4 個 JSON 檔案存在
2. **Phase 2**：啟動組裝 Agent
   - 讀取 4 個 JSON → 計算總分 → 識別問題 → 自動修正（最多 5 項）→ 生成報告 → 寫入 RAG → 清理中間檔案
   - Timeout 1200s，失敗可重試 1 次（間隔 60 秒）

**預期耗時**：15-20 分鐘（單一模式需 25-30 分鐘）

### 手動執行

```powershell
# 進入專案目錄
cd D:\Source\daily-digest-prompt

# 團隊並行模式（推薦）
pwsh -ExecutionPolicy Bypass -File run-system-audit-team.ps1

# 單一模式（備用）
pwsh -ExecutionPolicy Bypass -File run-system-audit.ps1
```

---

## 輸出檔案

### 1. 審查報告

**位置**：`docs/系統審查報告_YYYYMMDD_HHMM.md`

**內容**：
- 執行摘要（總分、等級、與前次比對）
- 7 個維度詳細評分（38 個子項，含證據）
- 關鍵發現（前 5 個最弱項目）
- 修正記錄（本次自動修正的清單）
- 建議清單（需人工介入的項目）
- 趨勢分析（與前次審查的分數變化）

### 2. 知識庫記錄

**API**：`POST http://localhost:3000/api/notes`

**Metadata**：
```json
{
  "total_score": 90.47,
  "grade": "S",
  "date": "2026-02-17",
  "dimensions": {
    "security": 91,
    "architecture": 84,
    "quality": 91,
    "workflow": 96,
    "tech_stack": 92,
    "documentation": 88,
    "completeness": 93
  }
}
```

**Tags**：`["系統審查", "自動化", "品質評估"]`

### 3. 執行日誌

**團隊並行模式**（推薦）：
- `logs/audit-phase1-YYYYMMDD_HHMMSS.log`：Phase 1 四個並行 Agent 的合併輸出
- `logs/audit-phase2-YYYYMMDD_HHMMSS.log`：Phase 2 組裝 Agent 的輸出
- `results/audit-dim*.json`：中間結果（完成後自動清理）

**單一模式**（備用）：
- `logs/system-audit-YYYYMMDD_HHMMSS.log`：完整 Claude Agent 輸出

---

## 評分標準

### 7 個維度（加權總分 100）

| 維度 | 權重 | 子項數 |
|------|------|--------|
| 資訊安全 | 20% | 6 |
| 系統架構 | 18% | 6 |
| 系統品質 | 18% | 6 |
| 系統工作流 | 15% | 5 |
| 技術棧 | 10% | 5 |
| 系統文件 | 10% | 5 |
| 系統完成度 | 9% | 5 |

### 等級定義

- **S（卓越）**：90-100 分
- **A（優秀）**：80-89 分
- **B（良好）**：70-79 分
- **C（及格）**：55-69 分
- **D（待改善）**：40-54 分
- **F（不及格）**：0-39 分

---

## 自動修正範圍

### 可自動修正（最多 5 項）

- ✅ 新增缺失的配置檔案
- ✅ 提取硬編碼值到配置檔
- ✅ 更新過時文件
- ✅ 補充測試案例
- ✅ 修正格式錯誤

### 需人工介入

- ❌ 架構性變更（如模組重組）
- ❌ 外部服務整合（如建立 CI/CD）
- ❌ 需要人工決策的項目

---

## 排程建立

### 方法 1：批次建立（推薦）

```powershell
# 需要管理員權限
.\setup-scheduler.ps1 -FromHeartbeat
```

從 `HEARTBEAT.md` 讀取所有排程（含新增的 system-audit，使用團隊並行模式）並批次建立。

### 方法 2：單獨建立

```powershell
# 需要管理員權限（團隊並行模式，推薦）
.\setup-scheduler.ps1 -Time "00:40" -TaskName "Claude_system-audit" -Script "run-system-audit-team.ps1"

# 單一模式（備用）
.\setup-scheduler.ps1 -Time "00:40" -TaskName "Claude_system-audit" -Script "run-system-audit.ps1"
```

### 驗證排程

```powershell
# 查看所有 Claude 排程
Get-ScheduledTask | Where-Object {$_.TaskName -like "Claude_*"} | Select-Object TaskName, State

# 查看 system-audit 排程詳情
Get-ScheduledTask -TaskName "Claude_system-audit" | Get-ScheduledTaskInfo
```

---

## 故障排查

### 1. 排程未執行

**檢查**：
```powershell
Get-ScheduledTask -TaskName "Claude_system-audit" | Select-Object TaskName, State
```

**可能原因**：
- Task Scheduler 服務未啟動
- 排程被停用（State = Disabled）
- 權限不足

**解決**：
```powershell
# 啟用排程
Enable-ScheduledTask -TaskName "Claude_system-audit"

# 重新建立排程（管理員權限）
.\setup-scheduler.ps1 -FromHeartbeat
```

### 2. 知識庫寫入失敗

**檢查**：
```bash
# 測試知識庫 API
curl -X GET http://localhost:3000/api/health
```

**可能原因**：
- 知識庫服務未啟動
- localhost:3000 埠被佔用

**解決**：
- 啟動知識庫服務
- 審查會在本地保留報告，不阻塞流程

### 3. 審查超時

**檢查日誌**：
```powershell
# 團隊並行模式（查看最新 Phase 1 日誌）
Get-Content (Get-ChildItem logs\audit-phase1-*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1)

# 團隊並行模式（查看最新 Phase 2 日誌）
Get-Content (Get-ChildItem logs\audit-phase2-*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1)

# 單一模式（查看最新日誌）
Get-Content (Get-ChildItem logs\system-audit-*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1)
```

**可能原因**：
- Phase 1：某個並行 Agent 執行超過 600 秒
- Phase 2：組裝 Agent 執行超過 1200 秒
- 網路問題導致 API 呼叫緩慢

**解決**：
- 增加 timeout（修改 HEARTBEAT.md 的 timeout: 1800）
- 手動執行偵錯（團隊模式或單一模式）
- 檢查 `results/` 目錄是否有未清理的中間檔案

---

## 未來擴展

### 1. 告警機制

當分數低於閾值時，自動發送 ntfy 通知：
```yaml
# 在 daily-system-audit-prompt.md 加入
if total_score < 85:
  send_ntfy_alert(topic="wangsc2025", title="系統審查警告", message=f"總分 {total_score} 低於閾值")
```

### 2. 趨勢圖表

將歷史分數視覺化：
```python
# 讀取 state/last-audit.json 歷史記錄
# 生成 PNG 趨勢圖
# 附加到審查報告
```

### 3. 自動 PR

當修正完成後，自動建立 Pull Request：
```bash
git checkout -b auto-fix-$(date +%Y%m%d)
git add .
git commit -m "chore: 自動系統審查修正"
gh pr create --title "自動修正：系統審查建議" --body "$(cat 修正摘要.md)"
```

---

## 參考資料

- [system-audit Skill](../skills/system-audit/SKILL.md)
- [audit-scoring.yaml](../config/audit-scoring.yaml)
- [audit-report.md 模板](../templates/audit-report.md)
- [系統審查最終報告](./系統審查最終報告_2026-02-16.md)
- [HEARTBEAT.md](../HEARTBEAT.md)

---

**維護者**：Claude Sonnet 4.5
**最後更新**：2026-02-17
