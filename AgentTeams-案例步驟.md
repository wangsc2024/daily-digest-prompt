# Agent Teams 使用案例：並行程式碼審查

本文件以「**對 PR 做多面向並行審查**」為例，示範從啟動到收尾的完整步驟。

---

## 案例說明

**情境**：你有一個 Pull Request（例如 `#142`），希望同時從**資安**、**效能**、**測試覆蓋**三個角度審查，並由 lead 彙整成一份結論。

**為何用 Agent Teams**：單一 session 容易只偏重某一類問題；拆成三位獨立審查者並行執行，再彙整，可一次得到較完整的審查結果。

---

## 前置條件

- 已依 [ClaudeCodeTeamAgent.md](./ClaudeCodeTeamAgent.md) 在使用者目錄啟用 Agent Teams（`env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1`、`teammateMode: in-process`）。
- 在**該專案目錄**下啟動 Claude Code（`claude` 或從 Cursor/IDE 整合啟動）。

---

## 步驟一：進入專案並啟動 Claude Code

1. 開啟終端，切到該 repo 目錄：
   ```powershell
   cd D:\Source\your-repo
   ```
2. 啟動 Claude Code：
   ```powershell
   claude
   ```
3. 等待 REPL 出現，確認可正常輸入。

---

## 步驟二：下達「建立團隊 + 任務」的指令

在 Claude 的輸入區貼上（可依實際 PR 編號與路徑改）：

```
請建立一個 agent team 來審查 PR #142。需要三位審查者並行工作：
- 一位專注資安（token、session、輸入驗證等）
- 一位專注效能影響（查詢、迴圈、快取）
- 一位專注測試覆蓋與邊界案例

請讓他們各自審查並回報發現，最後由你彙整成一份審查摘要。
```

**要點**：一次說清楚「建立團隊」、「角色分工」、「產出（彙整摘要）」，lead 會據此建立任務與隊友。

---

## 步驟三：確認 Lead 建立團隊與隊友

1. Lead 會開始建立團隊、寫入任務清單，並 spawn 三位隊友。
2. 終端會出現隊友列表與各自負責的任務（若已開任務清單：**Ctrl+T** 可切換顯示）。
3. **In-process 模式**下，同一畫面會輪流顯示各隊友的輸出；用 **Shift+↑ / Shift+↓** 可切換「目前選中的隊友」。

**若隊友沒出現**：再對 lead 說一次「請建立三位審查者隊友，分別負責資安、效能、測試覆蓋」，或檢查 [ClaudeCodeTeamAgent.md](./ClaudeCodeTeamAgent.md) 的疑難排解一節。

---

## 步驟四：觀察並行審查（可選：直接與隊友對話）

1. **只觀察**：讓 lead 與三位隊友自動跑完，不需輸入。
2. **中途介入**：
   - 用 **Shift+↓** 選到某個隊友（例如「security reviewer」）。
   - 直接輸入補充指示，例如：「也檢查是否有硬編碼的 API key。」
   - 該隊友會依新指示繼續審查。
3. 用 **Ctrl+T** 可開關任務清單，查看哪些任務已完成、哪些進行中。

---

## 步驟五：請 Lead 彙整結果

當三位審查者都回報完（或你認為可以收斂時），對 lead 說：

```
請根據三位審查者的發現，彙整成一份審查摘要：
包含資安、效能、測試三大類的結論與建議，並標註優先級（高/中/低）。
```

Lead 會從隊友的訊息與任務結果彙整，產出摘要。你可再追問「寫成 PR comment 格式」或「輸出到 `pr-review-142.md`」等。

---

## 步驟六：關閉隊友並清理團隊

1. **關閉隊友**（可對 lead 一次說）：
   ```
   請請三位審查者隊友都關閉。
   ```
   Lead 會對各隊友送關閉請求，隊友同意後結束。
2. **清理團隊**：
   ```
   清理團隊
   ```
   Lead 會移除團隊資源；若有隊友仍在跑，cleanup 會失敗，需先完成步驟 1。

---

## 步驟總覽

| 步驟 | 動作 | 你要做的事 |
|------|------|------------|
| 1 | 進入專案、啟動 Claude Code | `cd` 到 repo，執行 `claude` |
| 2 | 下達建立團隊與任務 | 貼上「建立 agent team + 三位審查者 + 彙整摘要」的指令 |
| 3 | 確認團隊與隊友 | 看終端列表、必要時用 Shift+↑/↓、Ctrl+T |
| 4 | 觀察或介入 | 可選：Shift+↓ 選隊友、輸入補充指示 |
| 5 | 彙整結果 | 對 lead 說「彙整成審查摘要…」 |
| 6 | 收尾 | 請 lead 關閉隊友 → 再說「清理團隊」 |

---

## 其他可套用的案例

同一套「建立團隊 → 分配角色 → 並行執行 → 彙整 → 清理」流程，可套用在：

- **多假設除錯**：多位隊友各負責一種根因假設，彼此挑戰，最後收斂成結論並更新 `findings.md`。
- **新功能多角度探索**：一位 UX、一位架構、一位唱反調，從不同角度給建議後由 lead 彙整。
- **多模組並行重構**：每位隊友負責不同目錄/模組，避免改同一檔案造成衝突。

只要在**步驟二**把「角色與任務」改成上述情境，其餘步驟相同。詳細操作與快捷鍵見 [ClaudeCodeTeamAgent.md](./ClaudeCodeTeamAgent.md)。
