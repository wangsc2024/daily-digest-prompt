{
  "notes": [
    {
      "title": "互動式指令取得方案與 Long-Polling 技術解析",
      "contentText": "# 互動式指令取得方案與 Long-Polling 技術解析\n\n## 摘要\n\n本文整理 Daily Digest Prompt 專案在「定時輪詢 Todoist」之外，可採用的互動式指令取得方案。涵蓋 9 種方案的評估，深入介紹前 4 名推薦方案及 Claude Code Hooks 與 Todoist 整合，並以完整圖解說明 Long-Polling 通訊機制。\n\n---\n\n## 一、問題背景\n\n### 現有架構的限制\n\n目前專案唯一的指令來源是 Windows Task Scheduler 定時輪詢 Todoist（每小時一次，09:00-22:00）。\n\n兩個根本限制：\n\n1. **延遲高**：最長需等 59 分鐘才會被處理\n2. **單向性**：只能被動等待排程觸發，無法即時互動\n\n### 已有基礎設施\n\n- ntfy.sh（推播通知，topic: wangsc2025）\n- Gmail OAuth2\n- Todoist REST API v1\n- PowerShell 執行環境\n- Claude Code CLI（claude -p）\n\n---\n\n## 二、9 種方案總覽\n\n| # | 方案 | 複雜度 | 延遲 | 手機可用 | 無需公開 URL | 推薦度 |\n|---|------|--------|------|----------|-------------|--------|\n| 1 | ntfy 雙向通訊 | 低 | 1-3s | 是 | 是 | ★★★★★ |\n| 2 | Telegram Bot | 中 | 1-2s | 是 | 是 | ★★★★☆ |\n| 3 | 檔案監控 + 雲端同步 | 低-中 | 5-60s | 是 | 是 | ★★★☆☆ |\n| 4 | Todoist Webhook | 中-高 | <1s | 是 | 否 | ★★★☆☆ |\n| 5 | n8n 自架 | 中 | 1-3s | 透過網頁 | 是 | ★★★☆☆ |\n| 6 | Claude Code Hooks | 低 | N/A | 否 | 是 | ★★★☆☆ |\n| 7 | Email 觸發 | 中 | 1-15min | 是 | 是 | ★★☆☆☆ |\n| 8 | Web 儀表板 | 高 | 1-2s | 是 | 是 | ★★☆☆☆ |\n| 9 | 語音介面 | 中-高 | 2-5s | 否 | 是 | ★☆☆☆☆ |\n\n---\n\n## 三、方案 1：ntfy 雙向通訊（最推薦）\n\n### 核心概念\n\n專案已用 ntfy 做單向推播（Agent → 手機）。ntfy 同時支援訂閱功能，可反向使用（手機 → Agent），形成雙向指令通道。\n\n### 架構\n\n兩個 topic 形成閉環：\n- wangsc2025-cmd：指令頻道（手機 → 電腦）\n- wangsc2025：通知頻道（電腦 → 手機，已有）\n\n### ntfy 訂閱方式\n\n- CLI 訂閱：ntfy subscribe topic \"command\" — 最簡單\n- JSON 串流：curl -s ntfy.sh/topic/json — 持續連線\n- WebSocket：ntfy.sh/topic/ws — 雙向即時\n- SSE：ntfy.sh/topic/sse — Server-Sent Events\n- 一次性輪詢：ntfy.sh/topic/json?poll=1&since=30s\n\n### 指令路由\n\n- digest → run-agent-team.ps1（每日摘要）\n- todoist → run-todoist-agent.ps1（檢查 Todoist）\n- gmail → run-gmail-agent.ps1（檢查 Gmail）\n- health → check-health.ps1（系統健康）\n- status → 讀取 scheduler-state.json\n- run 自訂 prompt → claude -p \"prompt\"\n\n### 安全性三層防護\n\n1. 隨機 topic 名（不易猜中）\n2. 訊息 token 前綴驗證\n3. ntfy Access Token 認證\n\n### 優勢\n\n- 零新依賴（ntfy 已在用，App 已安裝）\n- 監聽器核心邏輯約 30-50 行 PowerShell\n- 延遲 1-3 秒\n- 不需要公開 URL\n\n---\n\n## 四、方案 2：Telegram Bot\n\n### 架構\n\n手機 Telegram App → Telegram Server（Bot 用 long-polling 拉取）→ Windows Bot 程式（Python）→ claude -p → 結果回覆到 Telegram\n\n### 關鍵：Long-Polling 不需要公開 URL\n\nBot 主動向 Telegram Server 發起 GET 請求拉取訊息，純 outbound 連線，NAT/防火牆不影響。\n\n### 現成專案\n\n- claude-code-telegram (RichardAtCT)：最完整，會話持久化、內建排程器、串流回應、外掛系統\n- Claude-Code-Remote (JessyTsui)：支援 Email/Discord/Telegram 多通道\n- claudecode-telegram (hanxiao)：輕量級 tmux 橋接\n\n### ntfy vs Telegram\n\n- ntfy：低互動、零依賴、適合快速觸發\n- Telegram：高互動（按鈕、串流、對話）、會話持久化、適合深度互動\n\n---\n\n## 五、方案 3：檔案監控 + 雲端同步\n\n利用 .NET 原生 System.IO.FileSystemWatcher 監控指令資料夾。搭配 OneDrive/Dropbox 即可從任何裝置投遞指令。\n\n- 零外部依賴（.NET 原生）\n- 離線可用\n- 延遲 5-60 秒（受雲端同步影響）\n- 適合作為備援通道\n\n---\n\n## 六、方案 4：Todoist Webhook + Claude Code Hooks\n\n### Todoist Webhook\n\n將「每小時輪詢」升級為「即時事件驅動」。Todoist 在任務變化時即時 POST 到指定 URL。\n\n主要障礙：需要公開 HTTPS 端點（ngrok/Cloudflare Tunnel/n8n）。\n\n可監聽事件：item:added、item:updated、item:completed。\n\n### Claude Code Hooks\n\n內建生命週期事件系統，5 個 Hook 點：\n\n- SessionStart：會話開始 → 環境初始化\n- PreToolUse：工具使用前 → 安全閘門\n- PostToolUse：工具使用後 → 進度追蹤\n- Stop：Agent 完成 → 自動通知/關閉任務\n- Notification：Claude 通知 → 轉發外部通道\n\n### 整合場景\n\n- Stop Hook：自動關閉 Todoist 任務 + 評論 + ntfy 通知\n- PreToolUse：攔截 rm -rf 等危險操作（exit 2）\n- PostToolUse：在 Todoist 任務添加進度評論\n\n### Hook 資料流\n\nClaude Code → stdin JSON → Hook Script → exit code → Claude Code（0=繼續，2=攔截）\n\n### 定位\n\nHooks 是強化任何方案的利器，與方案 1-4 互補而非互斥。\n\n---\n\n## 七、Long-Polling 技術解析\n\n### 三種通訊模式\n\n**短輪詢**：客戶端定期詢問「有新訊息嗎？」，伺服器立刻回應。間隔太長延遲高，太短浪費資源。\n\n**Long-Polling**：客戶端詢問「有新訊息嗎？」，伺服器「故意不回應」保持連線，直到有新資料才送回。然後客戶端立刻再發下一個請求。\n\n**WebSocket**：持久雙向通道，隨時互發訊息。\n\n### Long-Polling 完整流程（Telegram Bot）\n\n1. Bot 發起 GET /getUpdates?timeout=30（普通 HTTPS outbound 請求）\n2. 伺服器持有連線：有訊息立刻回應，無訊息等到 timeout（30秒）回空陣列\n3. Bot 收到回應後立刻再發請求，形成無限迴圈\n\n### 延遲對比\n\n- 短輪詢（60分鐘）：平均 30 分鐘延遲，每分鐘 0.017 次請求\n- 短輪詢（5秒）：0-5 秒延遲，每分鐘 12 次請求（浪費）\n- Long-Polling（30s）：0.1-0.3 秒延遲，每分鐘約 2 次請求（最佳平衡）\n- WebSocket：< 0.1 秒，0 次輪詢（最低但複雜）\n\n### offset 防重複機制\n\n類似 Kafka consumer offset。Bot 處理完訊息後，下次請求帶 offset = 最後 update_id + 1，伺服器只回傳更新的訊息。\n\n### 與 Webhook 的根本差異\n\n- Webhook（Push）：伺服器 POST 到你的電腦 → 需要公開 URL、HTTPS、開 port\n- Long-Polling（Pull）：你的電腦 GET 到伺服器 → 只有 outbound，零暴露\n\n### Long-Polling 本質\n\n客戶端問「有新消息嗎？」，伺服器回答「等一下，有了再告訴你」——然後保持連線直到有消息或超時。用最簡單的 HTTP 請求-回應模型，實現接近即時的推送效果。\n\n### ntfy 的等價物\n\n- JSON 串流：curl -s ntfy.sh/topic/json（持久連線）\n- SSE：curl -s ntfy.sh/topic/sse\n- 短輪詢 + since：curl ntfy.sh/topic/json?poll=1&since=30s\n\n---\n\n## 八、推薦實施順序\n\n| 階段 | 方案 | 投入 | 效益 |\n|------|------|------|------|\n| 1 | ntfy 雙向通訊 | 數小時 | 即時指令、零新依賴 |\n| 2 | Claude Code Hooks | 1 小時 | 自動通知、安全閘門 |\n| 3 | Telegram Bot | 1-2 天 | 對話式互動、串流回應 |\n| 4 | n8n 統一編排 | 2-3 天 | 多觸發源統一管理 |\n\n---\n\n## 九、五個方案的關係\n\n方案 1-4 解決「怎麼收指令」（ntfy/Telegram/檔案監控/Todoist Webhook），方案 5 解決「Agent 執行中的自動化」（Claude Code Hooks）。它們互相補充，不互相排斥。\n\n---\n\n## 參考資源\n\n- ntfy CLI subscribe：https://docs.ntfy.sh/subscribe/cli/\n- ntfy Subscription API：https://docs.ntfy.sh/subscribe/api/\n- claude-code-telegram：github.com/RichardAtCT/claude-code-telegram\n- Claude-Code-Remote：github.com/JessyTsui/Claude-Code-Remote\n- Claude Code Hooks：code.claude.com/docs/en/hooks-guide\n- Claude Code Agent SDK：code.claude.com/docs/en/headless\n- n8n Claude Code 整合：n8n.io/integrations/webhook/and/claude/",
      "tags": ["互動式指令", "long-polling", "ntfy", "telegram-bot", "claude-code-hooks", "todoist-webhook", "架構設計", "通訊協定"],
      "source": "import"
    }
  ],
  "autoSync": true
}