version: 2

# ============================================
# 分層安全策略預設集（Presets）
# ============================================
# 透過環境變數 HOOK_SECURITY_PRESET 選擇策略
# 預設：normal（未設定時）

presets:
  strict:
    description: "嚴格模式 - 所有規則啟用，無例外（適用於生產環境）"
    enabled_priorities: ["critical", "high", "medium", "low"]
    allow_bypass: false

  normal:
    description: "正常模式 - 所有規則啟用（預設，適用於一般開發）"
    enabled_priorities: ["critical", "high", "medium", "low"]
    allow_bypass: false

  permissive:
    description: "寬容模式 - 僅 critical/high 規則啟用（適用於除錯或測試）"
    enabled_priorities: ["critical", "high"]
    allow_bypass: true

# ============================================
# Bash 命令攔截規則（對應 hooks/pre_bash_guard.py）
# ============================================
# priority: critical > high > medium > low

bash_rules:
  - id: nul-redirect
    description: "禁止 nul 重導向"
    pattern: '(>|2>)\s*nul(\s|$|;|&|\|)'
    flags: IGNORECASE
    reason: "禁止 nul 重導向（會建立 nul 實體檔案）。請改用 > /dev/null 2>&1"
    guard_tag: nul-guard
    priority: critical  # 資料破壞風險

  - id: scheduler-state-write
    description: "禁止 Agent 寫入 scheduler-state.json"
    # 移除 contains 預檢查，改用精確的寫入操作匹配（排除 ls/cat/grep/python read 等只讀操作）
    pattern: '(?<![0-9&])>\s*[^&].*scheduler-state\.json|>>\s*.*scheduler-state\.json|(tee|cp|mv)\s+.*scheduler-state\.json|echo\s+.*>\s*.*scheduler-state\.json'
    reason: "禁止 Agent 寫入 scheduler-state.json（此檔案由 PowerShell 腳本維護）"
    guard_tag: state-guard
    priority: medium  # 狀態檔案保護

  - id: destructive-delete
    description: "禁止破壞性刪除"
    patterns:
      - 'rm\s+-[rR]f\s+/(\s|$)'
      - 'rm\s+-[rR]f\s+~'
      - 'rm\s+-[rR]f\s+\.(\s|$)'
      - 'rm\s+-[rR]f\s+\*'
    reason: "禁止破壞性刪除操作（根目錄/家目錄/當前目錄/萬用字元）"
    guard_tag: safety-guard
    priority: critical  # 資料破壞風險

  - id: destructive-delete-windows
    description: "禁止 Windows 風格的破壞性刪除操作"
    patterns:
      - 'del\s+/[sS]\s+/[qQ]?\s*[A-Za-z]:\\'
      - 'rmdir\s+/[sS]\s+/[qQ]?\s*[A-Za-z]:\\'
      - 'Remove-Item\s+.*-Recurse.*[A-Za-z]:\\'
      - 'Remove-Item\s+.*[A-Za-z]:\\.*-Recurse'
    flags: IGNORECASE
    reason: "禁止 Windows 破壞性刪除操作（del /s, rmdir /s, Remove-Item -Recurse 針對磁碟根目錄）"
    guard_tag: safety-guard
    priority: critical  # 資料破壞風險

  - id: force-push
    description: "禁止 force push 到 main/master"
    patterns:
      - 'git\s+push\s+.*--force.*\s+(main|master)(\s|$)'
      - 'git\s+push\s+-f\s+.*\s+(main|master)(\s|$)'
    reason: "禁止 force push 到 main/master 分支"
    guard_tag: git-guard
    priority: critical  # Git 歷史破壞風險

  - id: sensitive-env
    description: "禁止讀取敏感環境變數"
    patterns:
      - 'echo\s+\$[A-Z_]*(TOKEN|SECRET|KEY|PASSWORD|CREDENTIAL)'
      - 'printenv\s+.*(TOKEN|SECRET|KEY|PASSWORD)'
      - 'env\s*\|\s*grep\s+.*(TOKEN|SECRET|KEY|PASSWORD)'
    flags: IGNORECASE
    reason: "禁止讀取敏感環境變數"
    guard_tag: env-guard
    priority: high  # 敏感資料保護

  - id: sensitive-env-set
    description: "禁止透過 set 指令洩露環境變數"
    patterns:
      - '\bset\s*\|\s*grep\s+.*(TOKEN|SECRET|KEY|PASSWORD)'
    flags: IGNORECASE
    reason: "禁止透過 set 指令洩露敏感環境變數"
    guard_tag: env-guard
    priority: high  # 敏感資料保護

  - id: exfiltration
    description: "禁止透過網路傳送敏感變數"
    pattern: 'curl.*(-d|--data).*\$(TOKEN|SECRET|KEY|PASSWORD)'
    flags: IGNORECASE
    reason: "禁止透過網路傳送敏感變數"
    guard_tag: exfiltration-guard
    priority: critical  # 資料外洩風險

  - id: exfiltration-file
    description: "禁止透過 @file 方式外洩敏感檔案"
    patterns:
      - 'curl\s.*(-d|--data|--data-binary|--data-raw|--data-urlencode)\s+@\s*\.env\b'
      - 'curl\s.*(-d|--data|--data-binary|--data-raw|--data-urlencode)\s+@\s*credentials'
      - 'curl\s.*(-d|--data|--data-binary|--data-raw|--data-urlencode)\s+@\s*token\.json'
      - 'curl\s.*(-d|--data|--data-binary|--data-raw|--data-urlencode)\s+@\s*secrets\.json'
      - 'curl\s.*(-d|--data|--data-binary|--data-raw|--data-urlencode)\s+@\s*\.htpasswd'
      - 'curl\s.*(-d|--data|--data-binary|--data-raw|--data-urlencode)\s+@\s*id_rsa'
      - 'curl\s.*(-d|--data|--data-binary|--data-raw|--data-urlencode)\s+@\s*id_ed25519'
    flags: IGNORECASE
    reason: "禁止透過 curl @file 方式外洩敏感檔案（.env, credentials, token, secrets 等）"
    guard_tag: exfiltration-guard
    priority: critical  # 資料外洩風險

  - id: exfiltration-pipe
    description: "禁止透過 pipe 方式外洩敏感檔案"
    patterns:
      - 'cat\s+.*\.(env|htpasswd)\s*\|.*curl'
      - 'cat\s+.*(credentials|secrets|token)\.json\s*\|.*curl'
      - 'cat\s+.*(id_rsa|id_ed25519)\s*\|.*curl'
      - 'cat\s+.*\.(env|htpasswd)\s*\|.*(wget|nc\s)'
      - 'cat\s+.*(credentials|secrets|token)\.json\s*\|.*(wget|nc\s)'
    flags: IGNORECASE
    reason: "禁止透過 pipe 方式將敏感檔案內容傳送到外部網路"
    guard_tag: exfiltration-guard
    priority: critical  # 資料外洩風險

  - id: exfiltration-wget
    description: "禁止透過 wget 外洩敏感資料"
    patterns:
      - 'wget\s.*--post-data.*\$(TOKEN|SECRET|KEY|PASSWORD)'
      - 'wget\s.*--post-file\s*=?\s*\.env\b'
      - 'wget\s.*--post-file\s*=?\s*(credentials|secrets|token)\.json'
    flags: IGNORECASE
    reason: "禁止透過 wget 傳送敏感資料"
    guard_tag: exfiltration-guard
    priority: critical  # 資料外洩風險

  - id: exfiltration-subshell
    description: "禁止透過子 shell ($() / ``) 方式外洩敏感檔案"
    patterns:
      - '(curl|wget)\s.*(\$\(|`)cat\s+.*\.(env|htpasswd)'
      - '(curl|wget)\s.*(\$\(|`)cat\s+.*(credentials|secrets|token)\.json'
      - '(curl|wget)\s.*(\$\(|`)cat\s+.*(id_rsa|id_ed25519)'
    flags: IGNORECASE
    reason: "禁止透過子 shell ($() / ``) 方式外洩敏感檔案內容"
    guard_tag: exfiltration-guard
    priority: critical  # 資料外洩風險

  - id: exfiltration-base64
    description: "禁止透過 base64 編碼後外洩敏感檔案"
    patterns:
      - 'base64\s+\.env\b.*\|\s*(curl|wget)'
      - 'base64\s+(credentials|secrets|token)\.json.*\|\s*(curl|wget)'
      - 'base64\s+(id_rsa|id_ed25519).*\|\s*(curl|wget)'
      - 'base64\s+\.htpasswd.*\|\s*(curl|wget)'
      - 'cat\s+.*\.(env|htpasswd)\s*\|.*base64.*\|\s*(curl|wget)'
      - 'cat\s+.*(credentials|secrets|token)\.json\s*\|.*base64.*\|\s*(curl|wget)'
      - 'cat\s+.*(id_rsa|id_ed25519)\s*\|.*base64.*\|\s*(curl|wget)'
    flags: IGNORECASE
    reason: "禁止透過 base64 編碼後將敏感檔案內容傳送到外部網路"
    guard_tag: exfiltration-guard
    priority: critical  # 資料外洩風險

  - id: sensitive-env-powershell
    description: "禁止在管道/指令中讀取敏感 PowerShell 環境變數（$env:TOKEN=xxx 賦值除外）"
    pattern: "\\$env:(TODOIST_API_TOKEN|OPENAI_API_KEY|ANTHROPIC_API_KEY|CLAUDE_API_KEY|BOT_API_SECRET|GITHUB_TOKEN)\\s*(=|\\+|,|;|\\|)"
    reason: "偵測到敏感 PowerShell 環境變數使用（$env:TOKEN），安全管控"
    guard_tag: env-guard
    priority: high  # 敏感資料保護
    examples:
      - "echo $env:TODOIST_API_TOKEN | curl"
      - "curl -H \"auth: $env:BOT_API_SECRET\""
    exceptions:
      - "$env:TODOIST_API_TOKEN = ..."  # 環境變數賦值允許

# ============================================
# 檔案寫入攔截規則（對應 hooks/pre_write_guard.py）
# ============================================

write_rules:
  - id: nul-file
    description: "禁止寫入 nul 檔案"
    check: basename_equals
    value: "nul"
    case_insensitive: true
    reason: "禁止寫入 nul 檔案（Windows 上會建立實體檔案）"
    guard_tag: nul-guard
    priority: critical  # 資料破壞風險

  - id: scheduler-state
    description: "禁止 Agent 寫入 scheduler-state.json"
    check: path_contains
    value: "scheduler-state.json"
    reason: "禁止 Agent 寫入 scheduler-state.json（此檔案由 PowerShell 腳本維護）"
    guard_tag: state-guard
    priority: medium  # 狀態檔案保護

  - id: sensitive-files
    description: "禁止寫入敏感檔案"
    check: basename_in
    values: [".env", "credentials.json", "token.json", "secrets.json", ".htpasswd"]
    reason_template: "禁止寫入敏感檔案: {matched}"
    guard_tag: secret-guard
    priority: high  # 敏感資料保護

  - id: path-traversal
    description: "禁止路徑遍歷攻擊"
    check: path_traversal
    reason_template: "禁止路徑遍歷攻擊: 目標路徑在專案目錄外 ({resolved})"
    guard_tag: traversal-guard
    priority: critical  # 安全攻擊防護

  # 註解：SKILL.md 保護規則已移除，因為會阻擋用戶明確要求的合法修改
  # 改依賴 Git 版本控制作為安全網
  # - id: skill-md-protect
  #   description: "禁止 Agent 修改 SKILL.md 檔案"
  #   check: basename_equals
  #   value: "SKILL.md"
  #   reason: "SKILL.md 為系統行為定義，不可在執行期間修改"
  #   guard_tag: skill-protect

# ============================================
# 檔案讀取攔截規則（對應 hooks/pre_read_guard.py）
# ============================================

read_rules:
  - id: sensitive-path
    description: "禁止讀取敏感系統路徑"
    check: path_match
    patterns:
      - '\.ssh'
      - '\.gnupg'
      - 'credentials(?!\.example|\.sample)'  # 不匹配範例檔案
      # 僅匹配 .env 或 .env.local，明確排除 .env.example / .env.sample / .env.template
      - '\.env(?!\.example|\.sample|\.template)'
      - '\.env\.local'
      - '/etc/shadow'
      - '/etc/passwd'
      - '\.aws/credentials'
      - '\.kube/config'
    reason: "禁止讀取敏感系統檔案"
    guard_tag: read-guard
    priority: high  # 敏感資料保護

  - id: sensitive-read-files
    description: "禁止讀取敏感檔案"
    check: basename_in
    values: [".env", ".env.local", "credentials.json", "token.json",
             "secrets.json", ".htpasswd", "id_rsa", "id_ed25519"]
    reason_template: "禁止讀取敏感檔案: {matched}"
    guard_tag: secret-read-guard
    priority: high  # 敏感資料保護

  - id: windows-credentials
    description: "禁止讀取 Windows 憑據路徑"
    check: path_match
    patterns:
      - 'AppData.*Roaming.*Microsoft.*Credentials'
      - 'AppData.*Roaming.*Microsoft.*Protect'
      - 'Windows.*System32.*config.*SAM'
    reason: "禁止讀取 Windows 系統憑據"
    guard_tag: win-cred-guard
    priority: critical  # 系統安全風險

# =====================================================================
# 良性輸出模式（post_tool_logger 誤報過濾）
# =====================================================================
benign_output_patterns:
  - "erroraction"
  - "error_msg"
  - "errormsg"
  - "silentlycontinue"
  - "error_keywords"
  - "has_error"
  - "error_count"
  - "error-handling"
  - "on_error"
  - "onerror"
  - "stderr"
  - "no error"
  - "0 error"
  - "0 failed"
  - "error_tools"
  - "error_detect"
  - "failed_count"
  - "exit code: 0"
  - "exit code 0 "
  - "exit code 0\n"
  - "errors: []"
  - "errors: 0"
  - "error_category"
  - "error_classification"
  - "benign_patterns"
  - '"denied": false'
  - "錯誤: 0"
  - "失敗: 0"
  - "error-"
