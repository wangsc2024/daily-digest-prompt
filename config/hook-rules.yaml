version: 2

# ============================================
# 安全等級預設集（Gemini CLI 啟發的分層策略引擎）
# 選擇方式：環境變數 DIGEST_SECURITY_LEVEL（預設 strict）
# critical 優先級規則永遠不可被任何 preset 停用
# ============================================
presets:
  strict:
    description: "排程執行（預設）— 全部規則啟用"
    disabled_rules: []

  standard:
    description: "互動開發 — 放寬非關鍵規則"
    disabled_rules: ["sensitive-env"]

  permissive:
    description: "除錯模式 — 僅保留 critical 規則"
    disabled_rules: ["sensitive-env", "force-push"]

# Bash 命令攔截規則（對應 hooks/pre_bash_guard.py）
bash_rules:
  - id: nul-redirect
    priority: critical
    description: "禁止 nul 重導向"
    pattern: '(>|2>)\s*nul(\s|$|;|&|\|)'
    flags: IGNORECASE
    reason: "禁止 nul 重導向（會建立 nul 實體檔案）。請改用 > /dev/null 2>&1"
    guard_tag: nul-guard

  - id: scheduler-state-write
    priority: critical
    description: "禁止 Agent 寫入 scheduler-state.json"
    # 移除 contains 預檢查，改用精確的寫入操作匹配（排除 ls/cat/grep/python read 等只讀操作）
    pattern: '(?<![0-9&])>\s*[^&].*scheduler-state\.json|>>\s*.*scheduler-state\.json|(tee|cp|mv)\s+.*scheduler-state\.json|echo\s+.*>\s*.*scheduler-state\.json'
    reason: "禁止 Agent 寫入 scheduler-state.json（此檔案由 PowerShell 腳本維護）"
    guard_tag: state-guard

  - id: destructive-delete
    priority: critical
    description: "禁止破壞性刪除"
    patterns:
      - 'rm\s+-[rR]f\s+/(\s|$)'
      - 'rm\s+-[rR]f\s+~'
      - 'rm\s+-[rR]f\s+\.(\s|$)'
      - 'rm\s+-[rR]f\s+\*'
    reason: "禁止破壞性刪除操作（根目錄/家目錄/當前目錄/萬用字元）"
    guard_tag: safety-guard

  - id: force-push
    priority: high
    description: "禁止 force push 到 main/master"
    patterns:
      - 'git\s+push\s+.*--force.*\s+(main|master)(\s|$)'
      - 'git\s+push\s+-f\s+.*\s+(main|master)(\s|$)'
    reason: "禁止 force push 到 main/master 分支"
    guard_tag: git-guard

  - id: sensitive-env
    priority: medium
    description: "禁止讀取敏感環境變數"
    patterns:
      - 'echo\s+\$[A-Z_]*(TOKEN|SECRET|KEY|PASSWORD|CREDENTIAL)'
      - 'printenv\s+.*(TOKEN|SECRET|KEY|PASSWORD)'
      - 'env\s*\|\s*grep\s+.*(TOKEN|SECRET|KEY|PASSWORD)'
    flags: IGNORECASE
    reason: "禁止讀取敏感環境變數"
    guard_tag: env-guard

  - id: exfiltration
    priority: critical
    description: "禁止透過網路傳送敏感變數"
    pattern: 'curl.*(-d|--data).*\$(TOKEN|SECRET|KEY|PASSWORD)'
    flags: IGNORECASE
    reason: "禁止透過網路傳送敏感變數"
    guard_tag: exfiltration-guard

# 檔案寫入攔截規則（對應 hooks/pre_write_guard.py）
write_rules:
  - id: nul-file
    priority: critical
    description: "禁止寫入 nul 檔案"
    check: basename_equals
    value: "nul"
    case_insensitive: true
    reason: "禁止寫入 nul 檔案（Windows 上會建立實體檔案）"
    guard_tag: nul-guard

  - id: scheduler-state
    priority: critical
    description: "禁止 Agent 寫入 scheduler-state.json"
    check: path_contains
    value: "scheduler-state.json"
    reason: "禁止 Agent 寫入 scheduler-state.json（此檔案由 PowerShell 腳本維護）"
    guard_tag: state-guard

  - id: sensitive-files
    priority: high
    description: "禁止寫入敏感檔案"
    check: basename_in
    values: [".env", "credentials.json", "token.json", "secrets.json", ".htpasswd"]
    reason_template: "禁止寫入敏感檔案: {matched}"
    guard_tag: secret-guard

  - id: path-traversal
    priority: critical
    description: "禁止路徑遍歷攻擊"
    check: path_traversal
    reason_template: "禁止路徑遍歷攻擊: 目標路徑在專案目錄外 ({resolved})"
    guard_tag: traversal-guard

  # 註解：SKILL.md 保護規則已移除，因為會阻擋用戶明確要求的合法修改
  # 改依賴 Git 版本控制作為安全網
  # - id: skill-md-protect
  #   description: "禁止 Agent 修改 SKILL.md 檔案"
  #   check: basename_equals
  #   value: "SKILL.md"
  #   reason: "SKILL.md 為系統行為定義，不可在執行期間修改"
  #   guard_tag: skill-protect

# 檔案讀取攔截規則（對應 hooks/pre_read_guard.py）
read_rules:
  - id: sensitive-path
    priority: high
    description: "禁止讀取敏感系統路徑"
    check: path_match
    patterns:
      - '\.ssh'
      - '\.gnupg'
      - 'credentials(?!\.example|\.sample)'  # 不匹配範例檔案
      # 僅匹配 .env 或 .env.local，明確排除 .env.example / .env.sample / .env.template
      - '\.env(?!\.example|\.sample|\.template)'
      - '\.env\.local'
      - '/etc/shadow'
      - '/etc/passwd'
      - '\.aws/credentials'
      - '\.kube/config'
    reason: "禁止讀取敏感系統檔案"
    guard_tag: read-guard

  - id: sensitive-read-files
    priority: high
    description: "禁止讀取敏感檔案"
    check: basename_in
    values: [".env", ".env.local", "credentials.json", "token.json",
             "secrets.json", ".htpasswd", "id_rsa", "id_ed25519"]
    reason_template: "禁止讀取敏感檔案: {matched}"
    guard_tag: secret-read-guard

  - id: windows-credentials
    priority: high
    description: "禁止讀取 Windows 憑據路徑"
    check: path_match
    patterns:
      - 'AppData.*Roaming.*Microsoft.*Credentials'
      - 'AppData.*Roaming.*Microsoft.*Protect'
      - 'Windows.*System32.*config.*SAM'
    reason: "禁止讀取 Windows 系統憑據"
    guard_tag: win-cred-guard
