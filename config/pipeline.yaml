# config/pipeline.yaml
# æ¯æ—¥æ‘˜è¦ Agent ç®¡ç·šå®šç¾©
# ä¿®æ”¹æ­¤æ–‡ä»¶å¯èª¿æ•´åŸ·è¡Œæ­¥é©Ÿï¼Œä¸éœ€ç¢° prompt

version: 1
agent: daily-digest

# åˆå§‹åŒ–éšæ®µï¼ˆå›ºå®šï¼Œä¸å¯è·³éï¼‰
init:
  - action: read_skill_index
    file: skills/SKILL_INDEX.md

  - action: read_memory
    skill: digest-memory
    skill_file: skills/digest-memory/SKILL.md
    data_file: context/digest-memory.json
    on_missing: first_run

  - action: load_cache_policy
    skill: api-cache
    skill_file: skills/api-cache/SKILL.md
    config_ref: config/cache-policy.yaml

  - action: read_state
    file: state/scheduler-state.json
    mode: readonly  # Agent åªè®€ï¼ŒPowerShell è…³æœ¬è² è²¬å¯«å…¥

# ä¸»è¦æ­¥é©Ÿï¼ˆä¾åºåŸ·è¡Œï¼Œå¤±æ•—ä¸ä¸­æ–·æ•´é«”æµç¨‹ï¼‰
steps:
  - id: todoist
    name: "æŸ¥è©¢ Todoist ä»Šæ—¥å¾…è¾¦"
    skills: [todoist, api-cache]
    skill_files:
      - skills/todoist/SKILL.md
    cache_key: todoist
    output_section: "âœ… ä»Šæ—¥å¾…è¾¦"

  - id: news
    name: "æŸ¥è©¢æœ¬é€±å±æ±æ–°èï¼ˆå«æ”¿ç­–è§£è®€ï¼‰"
    skills: [pingtung-news, pingtung-policy-expert, api-cache]
    skill_files:
      - skills/pingtung-news/SKILL.md
      - skills/pingtung-policy-expert/SKILL.md
    chain: [pingtung-news, pingtung-policy-expert, knowledge-query]
    cache_key: pingtung-news
    output_section: "ğŸ“° æœ¬é€±å±æ±æ–°è"
    post_actions:
      - rag_enhance: true  # ç”¨çŸ¥è­˜åº«æœå°‹ç›¸é—œæ”¿ç­–ç­†è¨˜
      - mark_import_candidates:
          conditions:
            - "é ç®—ç ´å„„"
            - "æ–°å»ºè¨­å•Ÿç”¨"
            - "é¦–å‰µè¨ˆç•«"
            - "ç¸£é•·å‡ºå¸­"
      - score_citizen_impact: true  # ä»¥ 10 åˆ†åˆ¶æ¨™è¨˜æ°‘çœ¾æœ‰æ„Ÿåº¦

  - id: hackernews
    name: "æŸ¥è©¢ AI æŠ€è¡“å‹•æ…‹"
    skills: [hackernews-ai-digest, api-cache]
    skill_files:
      - skills/hackernews-ai-digest/SKILL.md
    cache_key: hackernews
    output_section: "ğŸ¤– AI æŠ€è¡“å‹•æ…‹"
    post_actions:
      - rag_enhance: true
      - mark_import_candidates:
          condition: "score >= 300"
      - write_to_rag: true  # å°‡çµæœå¯«å…¥ RAG çŸ¥è­˜åº«

  - id: habits
    name: "ç”Ÿæˆä»Šæ—¥ç¿’æ…£æç¤º"
    skills: [atomic-habits]
    skill_files:
      - skills/atomic-habits/SKILL.md
    output_section: "ğŸ’¡ ä»Šæ—¥ç¿’æ…£æç¤º"

  - id: learning
    name: "ç”Ÿæˆä»Šæ—¥å­¸ç¿’æŠ€å·§"
    skills: [learning-mastery]
    skill_files:
      - skills/learning-mastery/SKILL.md
    required: true  # ä¸å¯è·³é
    output_section: "ğŸ“š ä»Šæ—¥å­¸ç¿’æŠ€å·§"

  - id: knowledge
    name: "æŸ¥è©¢çŸ¥è­˜åº« + æ™ºæ…§åŒ¯å…¥"
    skills: [knowledge-query, api-cache]
    skill_files:
      - skills/knowledge-query/SKILL.md
    cache_key: knowledge
    output_section: "ğŸ“ çŸ¥è­˜åº«å›é¡§"
    sub_actions:
      - query_recent_notes: true
      - query_stats: true  # curl localhost:3000/api/statsï¼Œè¨˜éŒ„ total_notes
      - smart_import:
          check_candidates_from: [news, hackernews]
          dedup_method: hybrid_search
          dedup_threshold: 0.85  # score > 0.85 è¡¨ç¤ºé‡è¤‡ï¼Œè·³é
          on_no_candidates: "è¨˜éŒ„ã€ŒçŸ¥è­˜åº«åŒ¯å…¥ï¼š0 å‰‡ã€ï¼Œä»ç®—é€šéé©—è­‰"
          on_import_fail: "ä¸å½±éŸ¿æ•´é«”æµç¨‹"

  - id: zen
    name: "ç”Ÿæˆä½›å­¸ç¦ªèª"
    skills: []  # ç„¡å°æ‡‰ Skillï¼Œç›´æ¥ç”Ÿæˆ
    output_section: "â˜¸ï¸ ä½›å­¸ç¦ªèª"

# æ”¶å°¾éšæ®µ
finalize:
  - action: compile_digest
    format_file: config/digest-format.md

  - action: send_notification
    skill: ntfy-notify
    skill_file: skills/ntfy-notify/SKILL.md
    config_ref: config/notification.yaml

  - action: update_memory
    skill: digest-memory
    skill_file: skills/digest-memory/SKILL.md
    data_file: context/digest-memory.json

  - action: verify
    description: "Evidence-Based æœ€çµ‚é©—è­‰ï¼ˆæ¯é …éœ€æœ‰å¯¦éš›åŸ·è¡Œè­‰æ“šï¼‰"
    checks:
      - id: api_cache_compliance
        rule: "æ¯å€‹ API å‘¼å«å‰éƒ½å…ˆæŸ¥äº†å¿«å–"
      - id: policy_analysis_present
        rule: "è‡³å°‘ 1 å‰‡æ–°èæœ‰æ”¿ç­–è§£è®€ï¼ˆæ‘˜è¦å«ã€Œæ”¿ç­–èƒŒæ™¯ã€å€å¡Šï¼‰"
      - id: knowledge_import_attempted
        rule: "æœ‰å˜—è©¦åŒ¯å…¥åˆ¤æ–·ï¼ˆç„¡å€¼å¾—åŒ¯å…¥ä¹Ÿç®—é€šéï¼‰"
      - id: memory_updated
        rule: "digest-memory.json çš„ last_run ç‚ºä»Šå¤©"
        verify_method: "ç”¨ Read è®€å›ç¢ºèª"
      - id: notification_sent
        rule: "ntfy curl å›æ‡‰ HTTP 200"
