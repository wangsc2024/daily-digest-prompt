# config/routing.yaml
# Todoist 任務三層路由規則
# 修改此文件可調整任務篩選和 Skill 匹配，不需碰 prompt

version: 2

# 設計說明：
# - routing.yaml 中的標籤：Todoist 任務分類標籤（用戶手動添加到任務上）
# - SKILL.md 中的 triggers：Skill 啟動關鍵字（用於內容匹配）
# - 兩者服務於不同目的，不需要一一對應
#
# 例子：
# - 任務帶有「遊戲開發」標籤 → routing.yaml 路由到 game-design Skill
# - 任務描述包含「遊戲」關鍵字 → game-design Skill 的 triggers 匹配
# - 「遊戲開發」和「遊戲」是不同層面的觸發條件，各司其職

# 前置過濾（最先執行，優先於所有路由層）
pre_filter:
  description: "以下類型任務無論是否有標籤，一律跳過"
  exclude_categories:
    - name: "實體行動"
      examples: ["買東西", "運動", "打掃", "出門", "取件"]
    - name: "人際互動"
      examples: ["打電話", "開會", "面談", "聚餐", "拜訪"]
    - name: "個人事務"
      examples: ["繳費（非自動化）", "看醫生", "接送"]
  rule: "即使任務帶有可處理標籤，若內容本質為上述類型，仍跳過"

# Tier 1：標籤路由（信心度 100%）
label_routing:
  confidence: 100
  description: "Todoist 標籤直接映射到 Skill，匹配即可處理，跳過 Tier 2/3"

  label_match_rule: |
    ^prefix 匹配邏輯：Todoist 任務的 labels 陣列中，若任一 label 完全等於 ^prefix 去掉 ^ 後的文字，即算命中。
    例：任務 labels=["遊戲優化", "知識庫"] → 命中 "^遊戲優化" 和 "^知識庫"。
    多標籤命中多個映射時，合併所有 skills 和使用最寬 allowedTools。

  # 任務類型標籤（最高優先 — 覆寫 template_resolution）
  # 這些標籤明確表示「任務類型」而非「研究主題」，出現時一律使用指定模板
  # Skills 和 allowedTools 仍從所有命中標籤合併
  task_type_labels:
    - label: "研究"
      template_override: "templates/sub-agent/research-task.md"
      description: "任務含此標籤 → 無論其他標籤的模板優先級，一律使用研究模板"
    - label: "深度思維"
      template_override: "templates/sub-agent/research-task.md"
      description: "深度思維本質為研究分析，覆寫 code-task 等模板"

  # 模板衝突解決規則（多標籤命中不同模板時，且無 task_type_labels 覆寫）
  template_resolution:
    rule: "無 task_type_labels 覆寫時，按優先級取最具體者（數字越小越優先）"
    priority_order:
      1: "templates/sub-agent/game-task.md"       # 遊戲任務最具體
      2: "templates/sub-agent/code-task.md"       # 程式開發次之
      3: "templates/sub-agent/research-task.md"   # 研究任務
      4: "templates/sub-agent/skill-task.md"      # 一般 Skill 任務（最泛用）

  # 修飾標籤（不參與模板選擇，僅合併 skills/tools）
  modifier_labels:
    - label: "知識庫"
      behavior: "合併 skills（加入 knowledge-query）和 allowedTools（加入 Write），但不參與模板競爭"
      description: "跨切面修飾 — 代表「結果寫入知識庫」，不決定任務類型"
      fallback: "若為任務唯一標籤且無其他 Tier 命中，使用 templates/sub-agent/skill-task.md"

  mappings:
    "^Claude Code":
      skills: ["程式開發（Plan-Then-Execute）"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep"
      template: "templates/sub-agent/code-task.md"
    "^GitHub":
      skills: ["程式開發（Plan-Then-Execute）"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep"
      template: "templates/sub-agent/code-task.md"
    "^研究":
      skills: ["deep-research", "knowledge-query"]
      allowed_tools: "Read,Bash,Write,WebSearch,WebFetch"
      template: "templates/sub-agent/research-task.md"
    "^深度思維":
      skills: ["deep-research", "knowledge-query"]
      allowed_tools: "Read,Bash,Write,WebSearch,WebFetch"
      template: "templates/sub-agent/research-task.md"
    "^知識庫":
      skills: ["knowledge-query"]
      allowed_tools: "Read,Bash,Write"
      template: null  # modifier label — 不參與模板選擇，由其他標籤決定模板；若為唯一標籤則 fallback 到 skill-task.md
    "^AI":
      skills: ["hackernews-ai-digest"]
      allowed_tools: "Read,Bash,Write"
      template: "templates/sub-agent/skill-task.md"
    "^遊戲優化":
      skills: ["game-design"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep"
      template: "templates/sub-agent/game-task.md"
    "^遊戲開發":
      skills: ["game-design"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep"
      template: "templates/sub-agent/game-task.md"
    "^專案優化":
      skills: ["程式開發（Plan-Then-Execute）"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep"
      template: "templates/sub-agent/code-task.md"
    "^網站優化":
      skills: ["程式開發（Plan-Then-Execute）"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep"
      template: "templates/sub-agent/code-task.md"
    "^UI":
      skills: ["程式開發（Plan-Then-Execute）"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep"
      template: "templates/sub-agent/code-task.md"
    "^UI/UX":
      skills: ["程式開發（Plan-Then-Execute）"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep"
      template: "templates/sub-agent/code-task.md"
    "^Cloudflare":
      skills: ["web-research"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep,WebSearch,WebFetch"
      template: "templates/sub-agent/code-task.md"
    "^邏輯思維":
      skills: ["deep-research", "knowledge-query"]
      allowed_tools: "Read,Bash,Write,WebSearch,WebFetch"
      template: "templates/sub-agent/research-task.md"
    "^系統審查":
      skills: ["system-audit"]
      allowed_tools: "Read,Bash,Write,Glob,Grep,WebSearch,WebFetch"
      template: "templates/sub-agent/skill-task.md"
    "^品質評估":
      skills: ["system-audit"]
      allowed_tools: "Read,Bash,Write,Glob,Grep,WebSearch,WebFetch"
      template: "templates/sub-agent/skill-task.md"
    "^Chat系統":
      skills: ["程式開發（Plan-Then-Execute）"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep"
      template: "templates/sub-agent/code-task.md"
    "^專案規劃":
      skills: ["程式開發（Plan-Then-Execute）"]
      allowed_tools: "Read,Bash,Write,Edit,Glob,Grep"
      template: "templates/sub-agent/code-task.md"

# Tier 2：內容關鍵字比對（信心度 80%）
keyword_routing:
  confidence: 80
  description: "比對 SKILL_INDEX 速查表的觸發關鍵字"
  rule: "關鍵字命中任何 Skill → 自動提升為「可處理」（Skill 的存在本身就代表能力）"
  mappings:
    - keywords: ["屏東", "新聞", "縣政"]
      skills: ["pingtung-news", "pingtung-policy-expert"]
    - keywords: ["AI", "LLM", "GPT", "技術"]
      skills: ["hackernews-ai-digest"]
    - keywords: ["知識庫", "筆記", "RAG"]
      skills: ["knowledge-query"]
    - keywords: ["習慣", "行為改變"]
      skills: ["atomic-habits"]
    - keywords: ["學習", "技巧"]
      skills: ["learning-mastery"]
    - keywords: ["通知", "提醒"]
      skills: ["ntfy-notify"]
    - keywords: ["程式碼", "檔案操作", "自動化"]
      skills: []  # 依任務內容判斷 allowedTools
    - keywords: ["遊戲", "game", "遊戲設計", "遊戲品質", "HTML5", "遊戲同步", "game_web", "同步遊戲"]
      skills: ["game-design"]
    - keywords: ["深度思維", "洞見", "報告", "分析", "反思"]
      skills: ["knowledge-query"]
    - keywords: ["Cloudflare", "Pages", "部署", "網站", "CDN"]
      skills: ["web-research"]
    - keywords: ["GitHub", "開源", "trending", "repository"]
      skills: []
    - keywords: ["專案", "重構", "效能", "performance"]
      skills: []

# Tier 3：LLM 語義判斷（信心度 60%）
semantic_routing:
  confidence: 60
  description: "Tier 1/2 都未匹配時，根據任務描述進行語義分析"
  processable: ["程式碼開發", "檔案操作", "研究查詢", "自動化", "文件撰寫"]
  not_processable: ["實體行動（買東西、運動）", "人際互動（打電話、開會）", "個人事務（繳費、看醫生）"]

# 篩選結果輸出格式
output_format:
  processable: "✅ 可處理：[任務ID] 任務名稱 — 路由層級: Tier N (信心度 XX%) | 匹配 Skill: [skill1, skill2]"
  skipped: "⏭️ 跳過：  [任務ID] 任務名稱 — 跳過原因"

# Skill 同步檢查（偵測未匹配的標籤）
sync_check:
  enabled: true
  description: "在路由後，檢查是否有 Todoist 標籤不在 label_routing 映射中"
  rule: |
    遍歷所有任務的 labels：
    1. 若某 label 同時不在以下兩處 → 記錄為「未匹配標籤」：
       a. label_routing.mappings 的 key 列表中（去掉 ^ 比對）
       b. keyword_routing.mappings 中任一 keywords 陣列中（完全比對）
    2. 輸出警告：⚠️ 發現未匹配標籤：[label1, label2]（無 Skill 路由）
    3. 建議：考慮新增 Skill 或更新 routing.yaml
  frequency: "每次執行都檢查，但同一標籤 24 小時內只提醒一次"
  tracking_field: "context/auto-tasks-today.json → warned_labels"
